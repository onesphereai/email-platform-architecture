<!DOCTYPE html>
<html>
<head>
    <title>15_error_handling_sequence_flow</title>
    <meta charset="utf-8">
</head>
<body>
<!-- Confluence Storage Format -->
<h1>Error Handling &amp; Recovery - Flow Description</h1>
<br/>
<p><strong>Diagram</strong>: <code>15<em>error</em>handling_sequence.png</code></p>
<br/>
<h2>Overview</h2>
<p>This sequence diagram demonstrates the comprehensive error handling and recovery mechanisms in the Email Platform, including retry logic, dead letter queue processing, alerting, and manual recovery procedures.</p>
<br/>
<h2>Sequence Flow</h2>
<br/>
<table>
<thead>
<tr>
<th>Step</th>
<th>Source</th>
<th>Target</th>
<th>Method/Action</th>
<th>Description</th>
<th>Response/Result</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Marketing User</td>
<td>Angular UI</td>
<td>sendCampaign()</td>
<td>User initiates campaign sending</td>
<td>Send request initiated</td>
</tr>
<tr>
<td>2</td>
<td>Angular UI</td>
<td>API Gateway</td>
<td>POST /campaigns/send</td>
<td>UI sends campaign send request</td>
<td>Request forwarded</td>
</tr>
<tr>
<td>3</td>
<td>API Gateway</td>
<td>Email Processor</td>
<td>processEmailBatch()</td>
<td>Gateway routes to email processing</td>
<td>Processing started</td>
</tr>
<tr>
<td>4</td>
<td>Email Processor</td>
<td>Amazon SES</td>
<td>sendEmail()</td>
<td>Processor attempts to send email</td>
<td>Send attempt made</td>
</tr>
<tr>
<td>5</td>
<td>Amazon SES</td>
<td>Email Processor</td>
<td>return error (rate exceeded)</td>
<td>SES returns rate limiting error</td>
<td>Error received</td>
</tr>
<tr>
<td>6</td>
<td>Email Processor</td>
<td>CloudWatch Logs</td>
<td>logError()</td>
<td>Processor logs error details</td>
<td>Error logged</td>
</tr>
<tr>
<td>7</td>
<td>Email Processor</td>
<td>Email Processor</td>
<td>retryWithBackoff()</td>
<td>Processor initiates retry with exponential backoff</td>
<td>Retry scheduled</td>
</tr>
<tr>
<td>8</td>
<td>Email Processor</td>
<td>Amazon SES</td>
<td>sendEmail() [retry]</td>
<td>Processor retries email sending</td>
<td>Retry attempt made</td>
</tr>
<tr>
<td>9</td>
<td>Amazon SES</td>
<td>Email Processor</td>
<td>return error (still failing)</td>
<td>SES continues to return error</td>
<td>Retry failed</td>
</tr>
<tr>
<td>10</td>
<td>Email Processor</td>
<td>Dead Letter Queue</td>
<td>maxRetriesExceeded()</td>
<td>Processor sends message to DLQ after max retries</td>
<td>Message queued in DLQ</td>
</tr>
<tr>
<td>11</td>
<td>Email Processor</td>
<td>DynamoDB</td>
<td>updateCampaignStatus(failed)</td>
<td>Processor updates campaign status to failed</td>
<td>Status updated</td>
</tr>
<tr>
<td>12</td>
<td>Email Processor</td>
<td>SNS Alerts</td>
<td>triggerAlert()</td>
<td>Processor triggers alert notification</td>
<td>Alert sent</td>
</tr>
<tr>
<td>13</td>
<td>Dead Letter Queue</td>
<td>Error Handler</td>
<td>processFailedMessage()</td>
<td>DLQ triggers error handler for failed message</td>
<td>Error processing started</td>
</tr>
<tr>
<td>14</td>
<td>Error Handler</td>
<td>Error Handler</td>
<td>analyzeError()</td>
<td>Handler analyzes error type and cause</td>
<td>Error analyzed</td>
</tr>
<tr>
<td>15</td>
<td>Error Handler</td>
<td>CloudWatch Logs</td>
<td>logDetailedError()</td>
<td>Handler logs detailed error information</td>
<td>Detailed log created</td>
</tr>
<tr>
<td>16</td>
<td>Error Handler</td>
<td>DynamoDB</td>
<td>updateErrorMetrics()</td>
<td>Handler updates error metrics and statistics</td>
<td>Metrics updated</td>
</tr>
<tr>
<td>17</td>
<td>SNS Alerts</td>
<td>Support Team</td>
<td>sendAlert()</td>
<td>SNS sends alert to support team</td>
<td>Alert delivered</td>
</tr>
<tr>
<td>18</td>
<td>Support Team</td>
<td>CloudWatch Logs</td>
<td>investigateIssue()</td>
<td>Support team investigates using logs</td>
<td>Investigation started</td>
</tr>
<tr>
<td>19</td>
<td>Error Handler</td>
<td>SNS Alerts</td>
<td>notifyUser()</td>
<td>Handler triggers user notification</td>
<td>User notification sent</td>
</tr>
<tr>
<td>20</td>
<td>SNS Alerts</td>
<td>Angular UI</td>
<td>pushNotification()</td>
<td>SNS pushes notification to UI</td>
<td>Notification received</td>
</tr>
<tr>
<td>21</td>
<td>Angular UI</td>
<td>Marketing User</td>
<td>showErrorMessage()</td>
<td>UI displays error message to user</td>
<td>Error message shown</td>
</tr>
<tr>
<td>22</td>
<td>Support Team</td>
<td>Amazon SES</td>
<td>resolveIssue()</td>
<td>Support team resolves underlying issue</td>
<td>Issue resolved</td>
</tr>
<tr>
<td>23</td>
<td>Support Team</td>
<td>Dead Letter Queue</td>
<td>reprocessFailedMessages()</td>
<td>Support team triggers reprocessing</td>
<td>Reprocessing initiated</td>
</tr>
<tr>
<td>24</td>
<td>Dead Letter Queue</td>
<td>Email Processor</td>
<td>retryProcessing()</td>
<td>DLQ sends messages back for retry</td>
<td>Retry processing started</td>
</tr>
<tr>
<td>25</td>
<td>Email Processor</td>
<td>Amazon SES</td>
<td>sendEmail() [recovered]</td>
<td>Processor attempts sending after issue resolution</td>
<td>Send attempt made</td>
</tr>
<tr>
<td>26</td>
<td>Amazon SES</td>
<td>Email Processor</td>
<td>return success</td>
<td>SES returns successful delivery</td>
<td>Success confirmed</td>
</tr>
<tr>
<td>27</td>
<td>Email Processor</td>
<td>DynamoDB</td>
<td>updateStatus(sent)</td>
<td>Processor updates campaign status to sent</td>
<td>Status updated</td>
</tr>
<tr>
<td>28</td>
<td>Email Processor</td>
<td>SNS Alerts</td>
<td>notifyRecovery()</td>
<td>Processor notifies of successful recovery</td>
<td>Recovery notification sent</td>
</tr>
<tr>
<td>29</td>
<td>SNS Alerts</td>
<td>Angular UI</td>
<td>updateUI()</td>
<td>SNS triggers UI update</td>
<td>UI update initiated</td>
</tr>
<tr>
<td>30</td>
<td>Angular UI</td>
<td>Marketing User</td>
<td>showSuccessMessage()</td>
<td>UI displays success message</td>
<td>Success confirmation shown</td>
</tr>
</tbody>
</table>
<br/>
<h2>Error Handling Phases</h2>
<br/>
<h3>Phase 1: Initial Error Detection (Steps 1-6)</h3>
<ul>
<li><strong>Purpose</strong>: Detect and log initial errors during email processing</li>
<li><strong>Components</strong>: Email Processor, Amazon SES, CloudWatch Logs</li>
<li><strong>Error Types</strong>:</li>
<ul>
<li>Rate limiting errors</li>
<li>Authentication failures</li>
<li>Service unavailable errors</li>
<li>Invalid recipient errors</li>
</ul>
<li><strong>Actions</strong>: Error logging with context and correlation IDs</li>
</ul>
<br/>
<h3>Phase 2: Retry Logic (Steps 7-9)</h3>
<ul>
<li><strong>Purpose</strong>: Attempt automatic recovery through retry mechanisms</li>
<li><strong>Strategy</strong>: Exponential backoff with jitter</li>
<li><strong>Configuration</strong>:</li>
<ul>
<li>Initial delay: 1 second</li>
<li>Maximum delay: 300 seconds (5 minutes)</li>
<li>Maximum retries: 3 attempts</li>
<li>Backoff multiplier: 2.0</li>
</ul>
<li><strong>Outcome</strong>: Either successful retry or escalation to DLQ</li>
</ul>
<br/>
<h3>Phase 3: Dead Letter Queue Processing (Steps 10-16)</h3>
<ul>
<li><strong>Purpose</strong>: Handle messages that exceed maximum retry attempts</li>
<li><strong>Components</strong>: Dead Letter Queue, Error Handler, DynamoDB</li>
<li><strong>Processing</strong>:</li>
<ul>
<li>Message analysis and categorization</li>
<li>Error metrics collection</li>
<li>Detailed logging for troubleshooting</li>
</ul>
<li><strong>Outcome</strong>: Comprehensive error documentation and metrics</li>
</ul>
<br/>
<h3>Phase 4: Alerting and Notification (Steps 17-21)</h3>
<ul>
<li><strong>Purpose</strong>: Notify relevant parties of system issues</li>
<li><strong>Recipients</strong>:</li>
<ul>
<li>Support team for technical issues</li>
<li>End users for campaign failures</li>
<li>Operations team for system-wide problems</li>
</ul>
<li><strong>Channels</strong>: SNS, email, Slack, PagerDuty</li>
<li><strong>Outcome</strong>: Stakeholders informed and investigation initiated</li>
</ul>
<br/>
<h3>Phase 5: Manual Recovery (Steps 22-30)</h3>
<ul>
<li><strong>Purpose</strong>: Resolve issues and recover failed operations</li>
<li><strong>Components</strong>: Support Team, Dead Letter Queue, Email Processor</li>
<li><strong>Process</strong>:</li>
<ul>
<li>Issue investigation and resolution</li>
<li>Failed message reprocessing</li>
<li>Status updates and user notification</li>
</ul>
<li><strong>Outcome</strong>: System recovery and user satisfaction</li>
</ul>
<br/>
<h2>Error Categories and Handling</h2>
<br/>
<h3>Transient Errors</h3>
<table>
<thead>
<tr>
<th>Error Type</th>
<th>Cause</th>
<th>Retry Strategy</th>
<th>Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td>Rate Limiting</td>
<td>SES sending limits exceeded</td>
<td>Exponential backoff</td>
<td>Wait and retry</td>
</tr>
<tr>
<td>Service Unavailable</td>
<td>Temporary AWS service issues</td>
<td>Linear backoff</td>
<td>Retry with delay</td>
</tr>
<tr>
<td>Network Timeout</td>
<td>Network connectivity issues</td>
<td>Immediate retry</td>
<td>Retry 2-3 times</td>
</tr>
<tr>
<td>Database Throttling</td>
<td>DynamoDB capacity exceeded</td>
<td>Exponential backoff</td>
<td>Auto-scaling kicks in</td>
</tr>
</tbody>
</table>
<br/>
<h3>Permanent Errors</h3>
<table>
<thead>
<tr>
<th>Error Type</th>
<th>Cause</th>
<th>Action</th>
<th>Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td>Invalid Email</td>
<td>Malformed email address</td>
<td>Skip recipient</td>
<td>Remove from list</td>
</tr>
<tr>
<td>Authentication Error</td>
<td>Invalid AWS credentials</td>
<td>Alert operations</td>
<td>Update credentials</td>
</tr>
<tr>
<td>Permission Denied</td>
<td>Insufficient IAM permissions</td>
<td>Alert operations</td>
<td>Update permissions</td>
</tr>
<tr>
<td>Resource Not Found</td>
<td>Missing template or data</td>
<td>Alert user</td>
<td>Recreate resource</td>
</tr>
</tbody>
</table>
<br/>
<h3>System Errors</h3>
<table>
<thead>
<tr>
<th>Error Type</th>
<th>Cause</th>
<th>Action</th>
<th>Resolution</th>
</tr>
</thead>
<tbody>
<tr>
<td>Lambda Timeout</td>
<td>Function execution timeout</td>
<td>Increase timeout</td>
<td>Optimize code</td>
</tr>
<tr>
<td>Memory Exhaustion</td>
<td>Insufficient Lambda memory</td>
<td>Increase memory</td>
<td>Optimize memory usage</td>
</tr>
<tr>
<td>Concurrent Execution</td>
<td>Lambda concurrency limit</td>
<td>Queue requests</td>
<td>Increase concurrency</td>
</tr>
<tr>
<td>Dead Letter Queue Full</td>
<td>Too many failed messages</td>
<td>Manual intervention</td>
<td>Process DLQ messages</td>
</tr>
</tbody>
</table>
<br/>
<h2>Retry Configuration</h2>
<br/>
<h3>Exponential Backoff Algorithm</h3>
<ac:structured-macro ac:name="code" ac:schema-version="1">
  <ac:parameter ac:name="language">javascript</ac:parameter>
  <ac:plain-text-body><![CDATA[
function calculateBackoffDelay(attempt, baseDelay = 1000, maxDelay = 300000) {
  const delay = Math.min(baseDelay * Math.pow(2, attempt), maxDelay);
  const jitter = Math.random() * 0.1 * delay; // Add 10% jitter
  return delay + jitter;
}

// Example retry delays:
// Attempt 1: ~1 second
// Attempt 2: ~2 seconds  
// Attempt 3: ~4 seconds
// Attempt 4: ~8 seconds (if configured)
]]></ac:plain-text-body>
</ac:structured-macro>
<br/>
<h3>Retry Policy Configuration</h3>
<ac:structured-macro ac:name="code" ac:schema-version="1">
  <ac:parameter ac:name="language">json</ac:parameter>
  <ac:plain-text-body><![CDATA[
{
  "retryPolicy": {
    "maxRetries": 3,
    "baseDelayMs": 1000,
    "maxDelayMs": 300000,
    "backoffMultiplier": 2.0,
    "jitterPercent": 10,
    "retryableErrors": [
      "ThrottlingException",
      "ServiceUnavailable",
      "InternalServerError",
      "NetworkTimeout"
    ],
    "nonRetryableErrors": [
      "InvalidParameterValue",
      "AccessDenied",
      "ResourceNotFound",
      "ValidationException"
    ]
  }
}
]]></ac:plain-text-body>
</ac:structured-macro>
<br/>
<h2>Dead Letter Queue Management</h2>
<br/>
<h3>DLQ Message Structure</h3>
<ac:structured-macro ac:name="code" ac:schema-version="1">
  <ac:parameter ac:name="language">json</ac:parameter>
  <ac:plain-text-body><![CDATA[
{
  "messageId": "msg_123456789",
  "originalTimestamp": "2024-01-15T10:30:00Z",
  "failureTimestamp": "2024-01-15T10:35:00Z",
  "retryCount": 3,
  "lastError": {
    "errorCode": "Throttling",
    "errorMessage": "Rate exceeded",
    "stackTrace": "...",
    "requestId": "req_123456789"
  },
  "originalMessage": {
    "campaignId": "camp_123456789",
    "recipients": ["user@example.com"],
    "templateId": "tmpl_123456789"
  }
}
]]></ac:plain-text-body>
</ac:structured-macro>
<br/>
<h3>DLQ Processing Workflow</h3>
<ol>
<li><strong>Message Analysis</strong>: Categorize error type and determine if recoverable</li>
<li><strong>Error Aggregation</strong>: Group similar errors for batch resolution</li>
<li><strong>Root Cause Analysis</strong>: Identify underlying system issues</li>
<li><strong>Recovery Planning</strong>: Determine recovery strategy and timeline</li>
<li><strong>Reprocessing</strong>: Retry messages after issue resolution</li>
<li><strong>Monitoring</strong>: Track recovery success rates</li>
</ol>
<br/>
<h2>Alerting Configuration</h2>
<br/>
<h3>Alert Severity Levels</h3>
<table>
<thead>
<tr>
<th>Level</th>
<th>Criteria</th>
<th>Response Time</th>
<th>Notification Channels</th>
</tr>
</thead>
<tbody>
<tr>
<td>Critical</td>
<td>System down, data loss</td>
<td>Immediate</td>
<td>PagerDuty, SMS, Phone</td>
</tr>
<tr>
<td>High</td>
<td>Service degradation</td>
<td>15 minutes</td>
<td>Email, Slack, PagerDuty</td>
</tr>
<tr>
<td>Medium</td>
<td>Error rate increase</td>
<td>1 hour</td>
<td>Email, Slack</td>
</tr>
<tr>
<td>Low</td>
<td>Performance degradation</td>
<td>4 hours</td>
<td>Email</td>
</tr>
</tbody>
</table>
<br/>
<h3>Alert Rules</h3>
<ac:structured-macro ac:name="code" ac:schema-version="1">
  <ac:parameter ac:name="language">json</ac:parameter>
  <ac:plain-text-body><![CDATA[
{
  "alertRules": [
    {
      "name": "High Error Rate",
      "condition": "error_rate > 5% for 5 minutes",
      "severity": "high",
      "channels": ["email", "slack"]
    },
    {
      "name": "DLQ Backup",
      "condition": "dlq_message_count > 100",
      "severity": "medium",
      "channels": ["email", "slack"]
    },
    {
      "name": "SES Quota Alert",
      "condition": "ses_quota_usage > 80%",
      "severity": "medium",
      "channels": ["email"]
    }
  ]
}
]]></ac:plain-text-body>
</ac:structured-macro>
<br/>
<h2>Error Metrics and Monitoring</h2>
<br/>
<h3>Key Metrics</h3>
<ul>
<li><strong>Error Rate</strong>: Percentage of failed operations</li>
<li><strong>Retry Success Rate</strong>: Percentage of successful retries</li>
<li><strong>DLQ Message Count</strong>: Number of messages in dead letter queue</li>
<li><strong>Mean Time to Recovery (MTTR)</strong>: Average time to resolve issues</li>
<li><strong>Mean Time Between Failures (MTBF)</strong>: Average time between failures</li>
</ul>
<br/>
<h3>Monitoring Dashboard</h3>
<ac:structured-macro ac:name="code" ac:schema-version="1">
  <ac:parameter ac:name="language">json</ac:parameter>
  <ac:plain-text-body><![CDATA[
{
  "dashboard": {
    "widgets": [
      {
        "type": "metric",
        "title": "Error Rate",
        "metric": "email.error_rate",
        "threshold": 5.0
      },
      {
        "type": "metric",
        "title": "DLQ Depth",
        "metric": "queue.dlq_message_count",
        "threshold": 100
      },
      {
        "type": "log",
        "title": "Recent Errors",
        "query": "ERROR level:error",
        "timeRange": "1h"
      }
    ]
  }
}
]]></ac:plain-text-body>
</ac:structured-macro>
<br/>
<h2>Recovery Procedures</h2>
<br/>
<h3>Automated Recovery</h3>
<ol>
<li><strong>Circuit Breaker</strong>: Stop processing when error rate is high</li>
<li><strong>Health Checks</strong>: Monitor service health and auto-recover</li>
<li><strong>Auto-scaling</strong>: Scale resources based on demand</li>
<li><strong>Failover</strong>: Switch to backup systems when primary fails</li>
</ol>
<br/>
<h3>Manual Recovery</h3>
<ol>
<li><strong>Issue Investigation</strong>: Analyze logs and metrics</li>
<li><strong>Root Cause Identification</strong>: Determine underlying cause</li>
<li><strong>Fix Implementation</strong>: Apply necessary fixes</li>
<li><strong>Message Reprocessing</strong>: Retry failed messages</li>
<li><strong>Monitoring</strong>: Verify recovery success</li>
</ol>
<br/>
<h3>Recovery Validation</h3>
<ac:structured-macro ac:name="code" ac:schema-version="1">
  <ac:parameter ac:name="language">javascript</ac:parameter>
  <ac:plain-text-body><![CDATA[
// Validate recovery by processing test messages
async function validateRecovery() {
  const testMessage = {
    campaignId: "test_recovery",
    recipients: ["test@example.com"],
    templateId: "test_template"
  };
  
  try {
    const result = await processEmailBatch(testMessage);
    if (result.success) {
      console.log("Recovery validated successfully");
      return true;
    }
  } catch (error) {
    console.error("Recovery validation failed:", error);
    return false;
  }
}
]]></ac:plain-text-body>
</ac:structured-macro>
<br/>
<h2>Preventive Measures</h2>
<br/>
<h3>Proactive Monitoring</h3>
<ul>
<li><strong>Predictive Alerts</strong>: Alert before issues become critical</li>
<li><strong>Trend Analysis</strong>: Monitor trends to predict failures</li>
<li><strong>Capacity Planning</strong>: Ensure adequate resources</li>
<li><strong>Performance Testing</strong>: Regular load testing</li>
</ul>
<br/>
<h3>System Resilience</h3>
<ul>
<li><strong>Redundancy</strong>: Multiple availability zones and regions</li>
<li><strong>Load Balancing</strong>: Distribute load across resources</li>
<li><strong>Rate Limiting</strong>: Prevent system overload</li>
<li><strong>Graceful Degradation</strong>: Maintain core functionality during issues</li>
</ul>
<br/>
<h3>Operational Excellence</h3>
<ul>
<li><strong>Runbooks</strong>: Documented procedures for common issues</li>
<li><strong>Training</strong>: Regular training for support team</li>
<li><strong>Post-Mortem</strong>: Learn from incidents and improve</li>
<li><strong>Automation</strong>: Automate common recovery procedures</li>
</ul>
<br/>
</body>
</html>