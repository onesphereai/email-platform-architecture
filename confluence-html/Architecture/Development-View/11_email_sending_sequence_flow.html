<!DOCTYPE html>
<html>
<head>
    <title>11_email_sending_sequence_flow</title>
    <meta charset="utf-8">
</head>
<body>
<!-- Confluence Storage Format -->
<h1>Email Sending Process - Flow Description</h1>
<br/>
<p><strong>Diagram</strong>: <code>11<em>email</em>sending_sequence.png</code></p>
<br/>
<h2>Overview</h2>
<p>This sequence diagram illustrates the complete email sending process, from user initiation through asynchronous processing, delivery, and real-time analytics updates.</p>
<br/>
<h2>Sequence Flow</h2>
<br/>
<table>
<thead>
<tr>
<th>Step</th>
<th>Source</th>
<th>Target</th>
<th>Method/Action</th>
<th>Description</th>
<th>Response/Result</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Marketing User</td>
<td>Angular UI</td>
<td>sendCampaign()</td>
<td>User triggers campaign sending</td>
<td>Send request initiated</td>
</tr>
<tr>
<td>2</td>
<td>Angular UI</td>
<td>API Gateway</td>
<td>POST /campaigns/{id}/send</td>
<td>UI sends campaign send request</td>
<td>Request forwarded</td>
</tr>
<tr>
<td>3</td>
<td>API Gateway</td>
<td>Campaign Service</td>
<td>triggerSend()</td>
<td>API Gateway routes send request</td>
<td>Send process triggered</td>
</tr>
<tr>
<td>4</td>
<td>Campaign Service</td>
<td>DynamoDB</td>
<td>updateStatus(sending)</td>
<td>Service updates campaign status</td>
<td>Status updated to &quot;sending&quot;</td>
</tr>
<tr>
<td>5</td>
<td>Campaign Service</td>
<td>Email Queue</td>
<td>queueEmailJobs()</td>
<td>Service queues email processing jobs</td>
<td>Jobs queued for processing</td>
</tr>
<tr>
<td>6</td>
<td>Campaign Service</td>
<td>API Gateway</td>
<td>return accepted</td>
<td>Service confirms send request accepted</td>
<td>Acceptance confirmed</td>
</tr>
<tr>
<td>7</td>
<td>API Gateway</td>
<td>Angular UI</td>
<td>return 202 Accepted</td>
<td>API returns accepted status</td>
<td>Async processing started</td>
</tr>
<tr>
<td>8</td>
<td>Angular UI</td>
<td>Marketing User</td>
<td>show sending status</td>
<td>UI displays sending status</td>
<td>User sees progress</td>
</tr>
<tr>
<td>9</td>
<td>Email Queue</td>
<td>Email Processor</td>
<td>processBatch()</td>
<td>Queue triggers batch processing</td>
<td>Batch processing started</td>
</tr>
<tr>
<td>10</td>
<td>Email Processor</td>
<td>DynamoDB</td>
<td>getCampaignData()</td>
<td>Processor retrieves campaign information</td>
<td>Campaign data retrieved</td>
</tr>
<tr>
<td>11</td>
<td>DynamoDB</td>
<td>Email Processor</td>
<td>return campaign</td>
<td>Database returns campaign details</td>
<td>Campaign data received</td>
</tr>
<tr>
<td>12</td>
<td>Email Processor</td>
<td>S3 Storage</td>
<td>getTemplate()</td>
<td>Processor retrieves email template</td>
<td>Template request sent</td>
</tr>
<tr>
<td>13</td>
<td>S3 Storage</td>
<td>Email Processor</td>
<td>return template</td>
<td>Storage returns template files</td>
<td>Template received</td>
</tr>
<tr>
<td>14</td>
<td>Email Processor</td>
<td>Template Service</td>
<td>renderTemplate()</td>
<td>Processor requests template rendering</td>
<td>Rendering initiated</td>
</tr>
<tr>
<td>15</td>
<td>Template Service</td>
<td>Email Processor</td>
<td>return rendered HTML</td>
<td>Service returns personalized HTML</td>
<td>Rendered content received</td>
</tr>
<tr>
<td>16</td>
<td>Email Processor</td>
<td>Amazon SES</td>
<td>sendEmailBatch()</td>
<td>Processor sends email batch to SES</td>
<td>Batch sent for delivery</td>
</tr>
<tr>
<td>17</td>
<td>Amazon SES</td>
<td>Email Processor</td>
<td>return messageIds</td>
<td>SES returns message identifiers</td>
<td>Message IDs received</td>
</tr>
<tr>
<td>18</td>
<td>Email Processor</td>
<td>DynamoDB</td>
<td>updateDeliveryStatus()</td>
<td>Processor updates delivery status</td>
<td>Status updated</td>
</tr>
<tr>
<td>19</td>
<td>Amazon SES</td>
<td>SNS Notifications</td>
<td>deliveryEvent()</td>
<td>SES publishes delivery events</td>
<td>Events published</td>
</tr>
<tr>
<td>20</td>
<td>SNS Notifications</td>
<td>Analytics Service</td>
<td>processEvent()</td>
<td>SNS triggers analytics processing</td>
<td>Event processing started</td>
</tr>
<tr>
<td>21</td>
<td>Analytics Service</td>
<td>DynamoDB</td>
<td>updateMetrics()</td>
<td>Service updates campaign metrics</td>
<td>Metrics updated</td>
</tr>
<tr>
<td>22</td>
<td>Analytics Service</td>
<td>SNS Notifications</td>
<td>publishUpdate()</td>
<td>Service publishes status update</td>
<td>Update published</td>
</tr>
<tr>
<td>23</td>
<td>SNS Notifications</td>
<td>Angular UI</td>
<td>notifyUI()</td>
<td>SNS notifies UI of status change</td>
<td>UI notification received</td>
</tr>
<tr>
<td>24</td>
<td>Angular UI</td>
<td>Marketing User</td>
<td>show delivery stats</td>
<td>UI displays updated delivery statistics</td>
<td>Real-time stats shown</td>
</tr>
</tbody>
</table>
<br/>
<h2>Process Phases</h2>
<br/>
<h3>Phase 1: Send Initiation (Steps 1-8)</h3>
<ul>
<li><strong>Purpose</strong>: User initiates campaign sending and receives confirmation</li>
<li><strong>Pattern</strong>: Synchronous request with asynchronous processing</li>
<li><strong>Components</strong>: Angular UI, API Gateway, Campaign Service</li>
<li><strong>Outcome</strong>: Campaign status updated, jobs queued, user notified</li>
</ul>
<br/>
<h3>Phase 2: Asynchronous Processing (Steps 9-18)</h3>
<ul>
<li><strong>Purpose</strong>: Process queued email jobs and prepare for delivery</li>
<li><strong>Pattern</strong>: Queue-based batch processing</li>
<li><strong>Components</strong>: Email Queue, Email Processor, Template Service</li>
<li><strong>Operations</strong>: Data retrieval, template rendering, personalization</li>
<li><strong>Outcome</strong>: Emails ready for delivery with tracking</li>
</ul>
<br/>
<h3>Phase 3: Email Delivery (Steps 16-18)</h3>
<ul>
<li><strong>Purpose</strong>: Send emails through Amazon SES</li>
<li><strong>Pattern</strong>: Batch delivery with message tracking</li>
<li><strong>Components</strong>: Email Processor, Amazon SES</li>
<li><strong>Features</strong>: Throttling, retry logic, delivery confirmation</li>
<li><strong>Outcome</strong>: Emails sent with message IDs for tracking</li>
</ul>
<br/>
<h3>Phase 4: Event Processing (Steps 19-24)</h3>
<ul>
<li><strong>Purpose</strong>: Process delivery events and update analytics</li>
<li><strong>Pattern</strong>: Event-driven real-time updates</li>
<li><strong>Components</strong>: SNS, Analytics Service, Angular UI</li>
<li><strong>Operations</strong>: Metrics calculation, status updates, UI notifications</li>
<li><strong>Outcome</strong>: Real-time delivery statistics and user feedback</li>
</ul>
<br/>
<h2>Data Flow Details</h2>
<br/>
<h3>Campaign Send Request</h3>
<ac:structured-macro ac:name="code" ac:schema-version="1">
  <ac:parameter ac:name="language">json</ac:parameter>
  <ac:plain-text-body><![CDATA[
{
  "campaignId": "camp_123456789",
  "sendAt": "immediate",
  "throttle": {
    "emailsPerMinute": 100,
    "emailsPerHour": 1000
  }
}
]]></ac:plain-text-body>
</ac:structured-macro>
<br/>
<h3>Email Queue Message</h3>
<ac:structured-macro ac:name="code" ac:schema-version="1">
  <ac:parameter ac:name="language">json</ac:parameter>
  <ac:plain-text-body><![CDATA[
{
  "campaignId": "camp_123456789",
  "batchId": "batch_001",
  "recipients": ["user1@example.com", "user2@example.com"],
  "templateId": "tmpl_123456789",
  "priority": "normal"
}
]]></ac:plain-text-body>
</ac:structured-macro>
<br/>
<h3>SES Delivery Response</h3>
<ac:structured-macro ac:name="code" ac:schema-version="1">
  <ac:parameter ac:name="language">json</ac:parameter>
  <ac:plain-text-body><![CDATA[
{
  "messageIds": [
    "0000014a-f896-4c07-b8b0-f6b9dee6d13e-000000",
    "0000014a-f896-4c07-b8b0-f6b9dee6d13f-000000"
  ],
  "batchId": "batch_001"
}
]]></ac:plain-text-body>
</ac:structured-macro>
<br/>
<h3>Analytics Event</h3>
<ac:structured-macro ac:name="code" ac:schema-version="1">
  <ac:parameter ac:name="language">json</ac:parameter>
  <ac:plain-text-body><![CDATA[
{
  "eventType": "email.sent",
  "campaignId": "camp_123456789",
  "messageId": "0000014a-f896-4c07-b8b0-f6b9dee6d13e-000000",
  "recipient": "user1@example.com",
  "timestamp": "2024-01-15T10:30:00Z"
}
]]></ac:plain-text-body>
</ac:structured-macro>
<br/>
<h2>Error Handling</h2>
<br/>
<h3>Send Request Errors</h3>
<ul>
<li><strong>Campaign not found</strong>: Return 404 Not Found</li>
<li><strong>Campaign already sent</strong>: Return 409 Conflict</li>
<li><strong>Invalid status</strong>: Return 400 Bad Request</li>
<li><strong>Permission denied</strong>: Return 403 Forbidden</li>
</ul>
<br/>
<h3>Processing Errors</h3>
<ul>
<li><strong>Template not found</strong>: Log error, skip batch</li>
<li><strong>Recipient validation failure</strong>: Filter invalid emails</li>
<li><strong>SES quota exceeded</strong>: Implement backoff and retry</li>
<li><strong>Database connection failure</strong>: Retry with exponential backoff</li>
</ul>
<br/>
<h3>Delivery Errors</h3>
<ul>
<li><strong>Hard bounces</strong>: Add to suppression list</li>
<li><strong>Soft bounces</strong>: Retry with delay</li>
<li><strong>Rate limiting</strong>: Implement throttling</li>
<li><strong>Service unavailable</strong>: Queue for retry</li>
</ul>
<br/>
<h2>Performance Optimizations</h2>
<br/>
<h3>Batch Processing</h3>
<ul>
<li><strong>Batch Size</strong>: Configurable batch sizes (default: 50 emails)</li>
<li><strong>Parallel Processing</strong>: Multiple concurrent batches</li>
<li><strong>Memory Management</strong>: Efficient memory usage for large campaigns</li>
</ul>
<br/>
<h3>Template Rendering</h3>
<ul>
<li><strong>Caching</strong>: Cache rendered templates for similar recipients</li>
<li><strong>Optimization</strong>: Minimize template complexity</li>
<li><strong>Compression</strong>: Compress large templates</li>
</ul>
<br/>
<h3>Database Operations</h3>
<ul>
<li><strong>Connection Pooling</strong>: Reuse database connections</li>
<li><strong>Batch Updates</strong>: Update multiple records in single operation</li>
<li><strong>Indexing</strong>: Optimize queries with proper indexes</li>
</ul>
<br/>
<h3>SES Integration</h3>
<ul>
<li><strong>Connection Reuse</strong>: Maintain persistent connections</li>
<li><strong>Retry Logic</strong>: Exponential backoff for failures</li>
<li><strong>Rate Limiting</strong>: Respect SES sending limits</li>
</ul>
<br/>
<h2>Monitoring and Observability</h2>
<br/>
<h3>Metrics Tracked</h3>
<ul>
<li><strong>Processing Rate</strong>: Emails processed per minute</li>
<li><strong>Delivery Rate</strong>: Successful deliveries percentage</li>
<li><strong>Error Rate</strong>: Failed processing percentage</li>
<li><strong>Queue Depth</strong>: Number of pending jobs</li>
</ul>
<br/>
<h3>Logging</h3>
<ul>
<li><strong>Campaign Events</strong>: Send initiation, completion, errors</li>
<li><strong>Processing Events</strong>: Batch processing, template rendering</li>
<li><strong>Delivery Events</strong>: SES responses, delivery confirmations</li>
<li><strong>Error Events</strong>: All error conditions with context</li>
</ul>
<br/>
<h3>Alerts</h3>
<ul>
<li><strong>High Error Rate</strong>: Alert when error rate exceeds threshold</li>
<li><strong>Queue Backup</strong>: Alert when queue depth is high</li>
<li><strong>SES Quota</strong>: Alert when approaching sending limits</li>
<li><strong>Processing Delays</strong>: Alert when processing is slow</li>
</ul>
<br/>
<h2>Security Considerations</h2>
<br/>
<h3>Data Protection</h3>
<ul>
<li><strong>Encryption</strong>: All data encrypted in transit and at rest</li>
<li><strong>Access Control</strong>: Tenant isolation enforced</li>
<li><strong>Audit Logging</strong>: All operations logged for compliance</li>
</ul>
<br/>
<h3>Email Security</h3>
<ul>
<li><strong>Authentication</strong>: SPF, DKIM, DMARC validation</li>
<li><strong>Reputation</strong>: Monitor sender reputation</li>
<li><strong>Suppression</strong>: Automatic suppression list management</li>
</ul>
<br/>
<h3>API Security</h3>
<ul>
<li><strong>Authentication</strong>: JWT token validation</li>
<li><strong>Authorization</strong>: Role-based access control</li>
<li><strong>Rate Limiting</strong>: Prevent abuse and overuse</li>
</ul>
<br/>
</body>
</html>